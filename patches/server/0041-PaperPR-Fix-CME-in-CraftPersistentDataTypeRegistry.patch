From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Gero <gecam59@gmail.com>
Date: Sat, 2 Oct 2021 20:08:30 +0200
Subject: [PATCH] PaperPR Fix CME in CraftPersistentDataTypeRegistry

Original code by PaperMC, licensed under GPL v3
You can find the original code on https://github.com/PaperMC/Paper/pull/8425

diff --git a/src/main/java/org/bukkit/craftbukkit/persistence/CraftPersistentDataTypeRegistry.java b/src/main/java/org/bukkit/craftbukkit/persistence/CraftPersistentDataTypeRegistry.java
index 579d7510f1a2a4de3d3b1aa921ef8462e8780d39..0ded00f53121c4c6df0f306ae34e60172579136e 100644
--- a/src/main/java/org/bukkit/craftbukkit/persistence/CraftPersistentDataTypeRegistry.java
+++ b/src/main/java/org/bukkit/craftbukkit/persistence/CraftPersistentDataTypeRegistry.java
@@ -90,6 +90,15 @@ public final class CraftPersistentDataTypeRegistry {
     }
 
     private final Map<Class, TagAdapter> adapters = new HashMap<>();
+    // Paper start - Fix CME
+    private TagAdapter getAdapter(Class type) {
+        TagAdapter adapter = this.adapters.get(type);
+        if (adapter != null) return adapter;
+        synchronized (this.adapters) {
+            return this.adapters.computeIfAbsent(type, CREATE_ADAPTER);
+        }
+    }
+    // Paper end - Fix CME
 
     /**
      * Creates a suitable adapter instance for the primitive class type
@@ -209,7 +218,7 @@ public final class CraftPersistentDataTypeRegistry {
      * type was found
      */
     public <T> Tag wrap(Class<T> type, T value) {
-        return this.adapters.computeIfAbsent(type, CREATE_ADAPTER).build(value);
+        return getAdapter(type).build(value); // Paper - Fix CME
     }
 
     /**
@@ -225,7 +234,7 @@ public final class CraftPersistentDataTypeRegistry {
      * type was found
      */
     public <T> boolean isInstanceOf(Class<T> type, Tag base) {
-        return this.adapters.computeIfAbsent(type, CREATE_ADAPTER).isInstance(base);
+        return getAdapter(type).isInstance(base); // Paper - Fix CME
     }
 
     /**
@@ -246,8 +255,10 @@ public final class CraftPersistentDataTypeRegistry {
      * type was found
      */
     public <T> T extract(Class<T> type, Tag tag) throws ClassCastException, IllegalArgumentException {
-        TagAdapter adapter = this.adapters.computeIfAbsent(type, CREATE_ADAPTER);
-        Preconditions.checkArgument(adapter.isInstance(tag), "The found tag instance (%s) cannot store %s", tag.getClass().getSimpleName(), type.getSimpleName());
+        TagAdapter adapter = getAdapter(type); // Paper - Fix CME
+        if (!adapter.isInstance(tag)) {
+            throw new IllegalArgumentException(String.format("`The found tag instance cannot store %s as it is a %s", type.getSimpleName(), tag.getClass().getSimpleName()));
+        }
 
         Object foundValue = adapter.extract(tag);
         Preconditions.checkArgument(type.isInstance(foundValue), "The found object is of the type %s. Expected type %s", foundValue.getClass().getSimpleName(), type.getSimpleName());
