From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: rafaelflromao <12960698+rafaelflromao@users.noreply.github.com>
Date: Mon, 12 Jun 2023 06:01:40 +0100
Subject: [PATCH] Sync event calls on async threads


diff --git a/src/main/java/dev/etil/mirai/MiraiConfig.java b/src/main/java/dev/etil/mirai/MiraiConfig.java
index 3614e8c9f63584fc8e2478c03cee05ad5d7201f3..1197c9323b86f29d98cf195eb91a0750186588c9 100644
--- a/src/main/java/dev/etil/mirai/MiraiConfig.java
+++ b/src/main/java/dev/etil/mirai/MiraiConfig.java
@@ -271,4 +271,17 @@ public class MiraiConfig {
             enableAsyncEntityTracker = temp;
         }
     }
+
+    public static boolean enableSyncEventCallsOnAsyncThreads;
+    public static boolean enableSyncEventCallsOnAsyncThreadsInitialized;
+
+    private static void syncEventCallsOnAsyncThreads() {
+        boolean temp = getBoolean("enable-sync-event-calls-on-async-threads", true,
+            "Whether or not sync event calls on async threads should be enabled. (If async entity tracker is enabled, this is enabled.)",
+            "You may encounter issues with plugins.");
+        if (!enableSyncEventCallsOnAsyncThreadsInitialized) {
+            enableSyncEventCallsOnAsyncThreadsInitialized = true;
+            enableSyncEventCallsOnAsyncThreads = temp;
+        }
+    }
 }
diff --git a/src/main/java/io/papermc/paper/plugin/manager/PaperEventManager.java b/src/main/java/io/papermc/paper/plugin/manager/PaperEventManager.java
index 0681c720046db860b840c6f7dcdc9655bed9b7f5..04269adfdd0065f1bf00a6570a2cc9b36dc673b6 100644
--- a/src/main/java/io/papermc/paper/plugin/manager/PaperEventManager.java
+++ b/src/main/java/io/papermc/paper/plugin/manager/PaperEventManager.java
@@ -41,7 +41,7 @@ class PaperEventManager {
             throw new IllegalStateException(event.getEventName() + " may only be triggered asynchronously.");
         } else if (!event.isAsynchronous() && !this.server.isPrimaryThread() && !this.server.isStopping()) {
             // Mirai start
-            if(MiraiConfig.enableAsyncEntityTracker) {
+            if(MiraiConfig.enableAsyncEntityTracker || MiraiConfig.enableSyncEventCallsOnAsyncThreads) {
                 MinecraftServer.getServer().executeBlocking(event::callEvent);
                 return;
             } else {
